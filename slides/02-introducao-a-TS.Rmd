---
title: "Modelagem de Séries Temporais"
author: "<img src = 'https://d33wubrfki0l68.cloudfront.net/9b0699f18268059bdd2e5c21538a29eade7cbd2b/67e5c/img/logo/cursor1-5.png' width = '20%'>"
date: ""
output:
  xaringan::moon_reader:
    css: ["css/xaringan-themer.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
knit: pagedown::chrome_print
---

```{r, child="00-preamble.Rmd"}

```

class: middle, center

---

```{r, include = FALSE}

library(tidyverse)

cetesb_pinheiros <- readRDS("../dados/cetesb_pinheiros.rds")

```


# Séries temporais

- Uma série temporal pode ser entendida como uma lista de números associadas a marcos de tempo.

- Do ponto de vista estritamente prático não há diferença entre:

.pull-left[

Duas variáveis: `tempo` e `x`

```{r, echo = FALSE}
  knitr::kable(
    tibble::tribble(
      ~tempo, ~x,
      1, 0.1,
      5, 0.18,
      3, 0.19,
      2, 0.22,
      4, 0.23
    )
  )
```
]

.pull-right[

uma variável `x` ordenada no tempo

```{r, echo = FALSE}
  knitr::kable(
    tibble::tribble(
      ~tempo, ~x,
      1, 0.1,
      2, 0.22,
      3, 0.19,
      4, 0.23,
      5, 0.18
    )
  )
```

]


- Na hora de analisar esses dados, entretanto, pensar que `x` está ordenado no tempo, e não que `tempo` é uma variável, dá **contexto** para as análises e provavelmente vai produzir resultados diferentes.

---

# Séries temporais no R

- Essa diferença entre os jeitos de interpretar uma série temporal resulta entre representações diferentes dentro do R também.

- `tibble` é o tipo de objeto padrão do `tidyverse`. Para interpretar uma `tibble` sempre como uma série temporal em qualquer contexto, vamos usar um pacote que se chama `tsibble`.

- Vamos ao R

---

# Porque séries temporais são especiais

- O tempo nunca para de passar: então pra qualquer variável $X_1, X_2, ..., X_n$ é verdade que elas estão ordenadas no tempo de algum jeito. 

- Vamos querer pensar que uma lista de números é uma série temporal porque **normalmente** tem uma diferença importante com relação a dados em que podemos ignorar a relação com o tempo. Nesse curso o contrário de "série temporal" será **dado transversal**.

- Na maior parte das aplicações e análises **transversais** aceitamos as hipóteses:

$$X_1 \text{ não tem relação com }X_2\text{, nem com }X_3\text{, nem com }X_4\text{ etc}$$
$$X_2 \text{ não tem relação com }X_1\text{, nem com }X_3\text{, nem com }X_4\text{ etc}$$
- Nas séries temporais essa é exatamente a hipótese que nós jogamos fora. Nesse tipo de análise vamos sempre pensar que os dados da série temporal tem algum tipo de relação importante que precisamos dar atenção na hora de analisar.

---

# Relações entre variáveis

- O conceito estatístico de dependência é muito importante aqui. Duas variáveis $X$ e $Y$ **não tem relação** se, quando fizermos um gráfico de $X$ contra $Y$ encontramos uma nuvem em que $Y$ sempre se distribui mais ou menos do mesmo jeito se fizermos cortes em $X$.

```{r, echo = FALSE, fig.height=6}

set.seed(11071995)

tibble(
  X = runif(1000),
  Y = runif(1000)) |> 
  ggplot(aes(x = X, y = Y)) + 
  geom_point() + 
  theme_bw() +
  geom_vline(xintercept = 0.125, col = 'red', size = 2) +
  geom_vline(xintercept = 0.25, col = 'red', size = 2) +
  geom_vline(xintercept = 0.625, col = 'darkgreen', size = 2) +
  geom_vline(xintercept = 0.75, col = 'darkgreen', size = 2)
```

---

# Relações entre variáveis

- Outro exemplo de variáveis não relacionadas:

```{r, echo = FALSE}

set.seed(11071995)

tibble(
  X = runif(5000, -2, 2),
  Y = rnorm(5000)) |> 
  ggplot(aes(x = X, y = Y)) + 
  geom_point() + 
  theme_bw() +
  geom_vline(xintercept = -1.8, col = 'red', size = 2) +
  geom_vline(xintercept = -1, col = 'red', size = 2) +
  geom_vline(xintercept = 1, col = 'darkgreen', size = 2) +
  geom_vline(xintercept = 1.8, col = 'darkgreen', size = 2)

```

---

# Relações entre variáveis

- Exemplo de variáveis relacionadas:

```{r, echo = FALSE}
set.seed(11071995)

tibble(
  X = runif(5000, -2, 2),
  Y = X + rnorm(5000, 0, .5)) |> 
  ggplot(aes(x = X, y = Y)) + 
  geom_point() + 
  theme_bw() +
  geom_vline(xintercept = -1.8, col = 'red', size = 2) +
  geom_vline(xintercept = -1, col = 'red', size = 2) +
  geom_vline(xintercept = 1, col = 'darkgreen', size = 2) +
  geom_vline(xintercept = 1.8, col = 'darkgreen', size = 2)
```

---

# Variáveis relacionadas e séries temporais

- No geral, quando manipulamos uma série temporal $X_t$ e construímos gráficos, por exemplo, de $X_{t-1}$ contra $X_t$, vamos identificar que existe relação entre essas variáveis.

- Chamamos os $X_{t-i}$ de **variáveis defasadas** ou **lags**. 

- Vamos ao R

---

# Relações entre variáveis

- Cuidado com a correlação linear, os gráficos são bons!

```{r, echo = FALSE, message=FALSE, error=FALSE, warning=FALSE}
anscombe_tidy <- anscombe %>%
    mutate(observation = seq_len(n())) %>%
    gather(key, value, -observation) %>%
    separate(key, c("variable", "set"), 1, convert = TRUE) %>%
    mutate(set = c("I", "II", "III", "IV")[set]) %>%
    spread(variable, value)

ggplot(anscombe_tidy, aes(x, y)) +
    geom_point(size = 3) +
    facet_wrap(~ set) +
    geom_smooth(method = "lm", se = FALSE, size =2) +
    theme_bw()
```

---

# Padrões comuns em séries temporais

Normalmente, tanto para previsão quanto para descrever vamos tentar enquadrar as séries temporais de acordo com alguns padrões:

- **Sazonalidade**: Periodicamente acontece alguma coisa com a série temporal? Padrões semanais, mensais etc?

- **Tendência**: Tem algo sistematicamente acontecendo nos dados? Por exemplo, a quantidade aumenta a cada ano?


---

# Entendendo a série temporal

Pensar nos componentes da série (tendência/sazonalidade) ajudam bastante a pensar
em como melhorar as previsões.

```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width="100%", fig.dim=c(8, 5), fig.retina=2}
library(fable)
library(feasts)
soja <- readRDS("../dados/soja.rds")
soja_ts <- soja %>% 
  mutate(DATA = tsibble::yearmonth(paste(CO_ANO, CO_MES))) %>% 
  as_tsibble(index = DATA)

soja_ts %>% 
  model(
    STL(
      KG_LIQUIDO ~ trend() + season()
    )) |>
  components() %>% 
  autoplot()
```

---

# Médias móveis

Médias móveis é uma forma comum de estimar a tendência de uma série temporal,
retirando variações perródicas que podem não importar.

Ex: Nas notícias sobre COVID é reportado a média móvel dos últimos 7 dias ao invés
do valor exato.

```{r, echo=FALSE, fig.retina=2, fig.dim=c(8,4), out.width="100%"}
soja_ts %>% 
  mutate(
    MM = slider::slide_dbl(KG_LIQUIDO, .before = 6, .after = 6, mean, complete=TRUE)
  ) %>% 
  autoplot(KG_LIQUIDO) +
  geom_line(aes(y = MM), color = "red")
```

---

# Decomposição clássica

1. Fazemos a média móvel para estimar a tendência. (chamamos de $\hat{T}$).
2. Fazemos o valor da série menos a tendência. Agora calculamos a sazonalidade
fazendo a média dos valores para cada período.
3. Calculamos o resto.

```{r echo=FALSE, fig.retina=2, fig.dim=c(8,4), out.width="100%", warning=FALSE}
soja_ts %>%
  model(
    classical_decomposition(KG_LIQUIDO, type = "additive")
  ) %>%
  components() %>%
  autoplot()
```

---

# Decomposição STL

Um jeito de analisar séries temporais, inclusive de produzir previsões é aplicar o que se chama normalmente de decomposição STL, que tenta ajustar funções muito flexíveis na equação abaixo:

$$X(t) = S(t) + T(t) + E(t).$$

Aqui teremos $S(t)$ sendo um componente sazonal periódica, $T(t)$ é algo que aumenta ao longo do tempo.

Vantagens com relação aos outros métodos:

- Sazonalidade pode mudar ao longo do tempo
- Funciona com sazonalidades mais complexas (eg, nao precisa ser mensal, anual, etc.)

---
class: middle, center

[Vamos ao R!](https://github.com/curso-r/main-series/blob/main/scripts/02-decomposicao.R)


